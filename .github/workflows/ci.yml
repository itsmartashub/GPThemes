name: ðŸ“¦ Extension CI/CD and Packaging

on:
    workflow_dispatch: # Trigger manually via GitHub UI
    pull_request: # Trigger on pull requests for status checks

jobs:
    build-and-package:
        name: Build, zip, and test
        runs-on: ubuntu-latest

        steps:
            - name: âš™ï¸ Checkout repo
              uses: actions/checkout@v4

            - name: ðŸ”– Set short SHA
              id: slug
              run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

            # --- SETUP ENVIRONMENT ---

            # CRITICAL: Install pnpm FIRST before setup-node tries to cache it (whitelist the `pnpm/action-setup@*` under the Repo > Settings > Actions )
            - name: ðŸ“¦ Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: '10'

            - name: ðŸš€ Setup Node.js & pnpm
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: ðŸ“¦ Install pnpm deps
              run: pnpm install --frozen-lockfile # Use --frozen-lockfile for CI stability

            - name: ðŸ¦• Setup deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: 'v2.x'

            # --- BUILD & ZIP ---

            - name: ðŸ—ï¸ Build and Package Extensions (pnpm build:all)
              run: pnpm build:all

            # --- ARTIFACT UPLOAD ---

            - name: â¬†ï¸ Upload chromium ext
              uses: actions/upload-artifact@v4
              with:
                  name: gpthemes-chromium${{ github.event.pull_request.number && format('-PR{0}', github.event.pull_request.number) || '-debug' }}
                  path: build/prod/*-chromium-*/**/*
                  retention-days: 7

            - name: â¬†ï¸ Upload firefox ext
              uses: actions/upload-artifact@v4
              with:
                  name: gpthemes-firefox${{ github.event.pull_request.number && format('-PR{0}', github.event.pull_request.number) || '-debug' }}
                  path: build/prod/*-firefox-*/**/*
                  retention-days: 7

            # - name: â¬†ï¸ Upload release zips
            #   uses: actions/upload-artifact@v4
            #   with:
            #       # Use PR number if available, otherwise fall back to SHA (for manual triggers)
            #       name: GPThemes-debug-${{ github.event.pull_request.number && format('PR{0}', github.event.pull_request.number) || format('build{0}', github.run_number) }}
            #       path: build/releases/*
            #       retention-days: 7 # Keep artifacts for a week

    report:
        # Use always() instead of failure() if you want the report step to run
        if: failure()
        needs: [build-and-package]
        runs-on: ubuntu-latest
        steps:
            - name: âš ï¸ Failure Report
              run: |
                  echo "### âŒ Build/packaging failed" >> $GITHUB_STEP_SUMMARY
                  echo "Review the logs for the 'Build and package extensions' step." >> $GITHUB_STEP_SUMMARY
                  echo "Job status: ${{ needs.build-and-package.result }}" >> $GITHUB_STEP_SUMMARY
