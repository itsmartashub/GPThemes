name: ðŸ“¦ Extension CI/CD and Packaging

on:
    workflow_dispatch:
    inputs:
      skip_build: # allows skipping the build itself for fast lint checks
          description: 'Set to true to skip the main build/packaging job'
          required: false
          default: 'false'
          type: boolean
      skip_biome:
          description: 'Set to true to skip Biome (JS) lint checks'
          required: false
          default: 'false'
          type: boolean
      skip_stylelint:
          description: 'Set to true to skip Stylelint (CSS/SCSS) checks'
          required: false
          default: 'false'
          type: boolean
    pull_request: # trigger on PR for status checks

permissions:
    contents: read # only read repo files
    pull-requests: write # only write PR comments/artifacts if needed

jobs:
    build-and-package:
        name: Build, zip, and test
        runs-on: ubuntu-latest

        steps:
            - name: âš™ï¸ Checkout repo
              uses: actions/checkout@v4

            # --- SETUP ENVIRONMENT ---

            # CRITICAL: install pnpm FIRST before setup-node tries to cache it (!! whitelist the `pnpm/action-setup@*` under the Repo > Settings > Actions !!)
            - name: ðŸ“¦ Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: "10"

            - name: ðŸš€ Setup Node.js & pnpm
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: ðŸ“¦ Install pnpm deps
              run: pnpm install --frozen-lockfile # use --frozen-lockfile for CI stabilty

            - name: ðŸ” Run all linting (Biome and Stylelint)
            # the '|| true' ensures the step alwasy succeeds (exit code 0)
              run: |
                  echo "--- Running Biome Lint (pnpm lint) ---"
                  pnpm lint || true
                  echo "--- Running Stylelint (pnpm slint) ---"
                  pnpm slint || true

            - name: ðŸ¦• Setup deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: "v2.x"

            # --- BUILD & ZIP ---

            - name: ðŸ—ï¸ Build and package ext (pnpm build:all)
              run: pnpm build:all

            # --- ARTIFACT NAMING HELPERS ---

            - name: ðŸ§® Short SHA
              id: sha
              # PR trigger: use PR head SHA
              # manual or push trigger: use commit SHA
              # take first 7 chars
              run: |
                  if [ "${{ github.event.pull_request }}" != "" ]; then
                    SHA=$(jq -r .pull_request.head.sha $GITHUB_EVENT_PATH)
                  else
                    SHA=$GITHUB_SHA
                  fi
                  echo "short=${SHA:0:7}" >> $GITHUB_OUTPUT

            # --- ARTIFACT UPLOAD ---

            - name: â¬†ï¸ Upload release zips
              uses: actions/upload-artifact@v4
              with:
                  # use PR number if available, otherwise fall back to SHA (for manual triggers)
                  name: ${{ github.event.pull_request.number
                      && format('ext-debug-PR#{0}-{1}', github.event.pull_request.number, steps.sha.outputs.short)
                      || format('ext-debug-build-{0}', steps.sha.outputs.short) }}
                  path: build/releases/*
                  # retention-days: 7 # Keep artifacts for a week

    report:
        # use always() instead of failure() if you want the report step to run
        if: failure()
        needs: [build-and-package]
        runs-on: ubuntu-latest
        steps:
            - name: âš ï¸ Failure report
              run: |
                  echo "### âŒ Build/packaging failed" >> $GITHUB_STEP_SUMMARY
                  echo "Review the logs for the 'Build and package extensions' step." >> $GITHUB_STEP_SUMMARY
                  echo "Job status: ${{ needs.build-and-package.result }}" >> $GITHUB_STEP_SUMMARY
